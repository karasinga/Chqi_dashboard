{% extends "research_dashboard/base.html" %}
{% load static %}

{% block content %}
<div>
    <!-- Navigation Tabs -->
    <div class="card mb-4">
        <div class="card-header">
            {% include 'research_dashboard/partials/project_navbar.html' with current_view=current_view project=project %}
        </div>
    </div>

    <!-- Content will be loaded here -->
    <div id="project-content">
        {% if current_view == 'overview' %}
            {% include 'research_dashboard/partials/overview_content.html' %}
        {% elif current_view == 'timeline' %}
            {% include 'research_dashboard/partials/timeline_content.html' %}
        {% elif current_view == 'metrics' %}
            {% include 'research_dashboard/partials/metrics_content.html' %}
        {% else %}
            {% include 'research_dashboard/partials/overview_content.html' %}
        {% endif %}
    </div>
    
    <!-- Hidden field to store current view for form submissions -->
    <input type="hidden" id="current-view" value="{{ current_view }}">
</div>

{% include "research_dashboard/modals.html" %}

{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const projectNavLinks = document.querySelectorAll('.project-nav-link');
        const projectContent = document.getElementById('project-content');
        const currentViewInput = document.getElementById('current-view');

        projectNavLinks.forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();

                const view = this.dataset.view;
                const url = this.href;

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.getElementById('project-content');
                        
                        projectContent.innerHTML = newContent.innerHTML;

                        // Re-evaluate script tags
                        const scripts = newContent.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.innerHTML = script.innerHTML;
                            }
                            projectContent.appendChild(newScript);
                        });
                        currentViewInput.value = view;

                        // Update active class on nav links
                        projectNavLinks.forEach(navLink => {
                            navLink.classList.remove('active');
                        });
                        this.classList.add('active');

                        // Update URL in browser
                        history.pushState({view: view}, '', url);
                    })
                    .catch(error => {
                        console.error('Error loading content:', error);
                    });
            });
        });

        window.addEventListener('popstate', function (event) {
            if (event.state && event.state.view) {
                const url = location.href;
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const newContent = doc.getElementById('project-content');
                        
                        projectContent.innerHTML = newContent.innerHTML;

                        // Re-evaluate script tags
                        const scripts = newContent.querySelectorAll('script');
                        scripts.forEach(script => {
                            const newScript = document.createElement('script');
                            if (script.src) {
                                newScript.src = script.src;
                            } else {
                                newScript.innerHTML = script.innerHTML;
                            }
                            projectContent.appendChild(newScript);
                        });
                        currentViewInput.value = event.state.view;

                        // Update active class on nav links
                        projectNavLinks.forEach(navLink => {
                            navLink.classList.remove('active');
                            if (navLink.dataset.view === event.state.view) {
                                navLink.classList.add('active');
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error loading content on popstate:', error);
                    });
            }
        });
    });
</script>

{% endblock scripts %}
