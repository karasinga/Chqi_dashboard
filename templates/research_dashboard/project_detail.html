{% extends "research_dashboard/base.html" %}
{% load static %}

{% block content %}
<style>
    /* Constrain Gantt chart width and make responsive */
#gantt-chart {
    max-width: 100%;
    overflow-x: auto;
    margin-bottom: 20px;
}

.gantt-container {
    width: auto;
    min-width: 300px;
    font-family: Arial, sans-serif;
}

.gantt .bar {
    rx: 2px;
    ry: 2px;
}

.gantt .bar-progress {
    rx: 2px;
    ry: 2px;
}

.gantt-header {
    font-size: 12px;
    font-weight: bold;
}

.gantt-popup {
    font-size: 14px;
    padding: 8px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.phase-context-menu {
    z-index: 1000;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

</style>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>{{ project.title }}</h4>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPhaseModal">
            <i class="mdi mdi-plus"></i> Add Phase
        </button>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMilestoneModal">
            <i class="mdi mdi-plus"></i> Add Milestone
        </button>
        <a href="{% url 'evaluations' %}?project={{ project.id }}" class="btn btn-sm btn-outline-primary">
            <i class="mdi mdi-clipboard-list"></i> Evaluations
        </a>
        <div>
            <span class="badge 
                {% if project.status == 'active' %}bg-primary
                {% elif project.status == 'completed' %}bg-success
                {% elif project.status == 'on_hold' %}bg-warning
                {% else %}bg-secondary{% endif %} me-2">
                {{ project.get_status_display }}
            </span>           
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Project Overview -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Project Overview</h5>
                    <p class="card-text">{{ project.description }}</p>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light p-2 rounded me-3">
                                    <i class="mdi mdi-calendar-start text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Start Date</small>
                                    <p class="mb-0">{{ project.start_date }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light p-2 rounded me-3">
                                    <i class="mdi mdi-calendar-end text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted">End Date</small>
                                    <p class="mb-0">{{ project.end_date|default:"-" }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-light p-2 rounded me-3">
                                    <i class="mdi mdi-account text-primary"></i>
                                </div>
                                <div>
                                    <small class="text-muted">Lead Researcher</small>
                                    <p class="mb-0">{{ project.lead_researcher|default:"-" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Progress Metrics -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Progress Metrics</h5>
                        <!-- <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMetricModal">
                            <i class="mdi mdi-plus"></i> Add Metric
                        </button> -->
                    </div>
                    {% if project.powerbi_url %}
                        <div class="ratio ratio-16x9">
                            <iframe src="{{ project.powerbi_url }}" frameborder="0" allowFullScreen="true"></iframe>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            No PowerBI dashboard configured for this project
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Phases -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Phases</h5>
                        <!-- <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPhaseModal">
                            <i class="mdi mdi-plus"></i> Add Phase
                        </button> -->
                        <span class="badge bg-light text-dark">
                            {{ phases|length }} total
                        </span>
                    </div>
                    
                    <div class="list-group list-group-flush phase-milestone-list" 
                         style="max-height: 300px; overflow-y: auto;">
                        {% for phase in phases %}
                        <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center flex-nowrap mb-1">
                                    <strong class="text-truncate me-2">{{ phase.get_phase_type_display }}</strong>
                                    <span class="badge {% if phase.completed %}bg-success{% else %}bg-warning{% endif %}">
                                        {% if phase.completed %}Completed{% else %}Active{% endif %}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center flex-nowrap">
                                    <p class="text-muted mb-0 small text-truncate">
                                        {{ phase.start_date }} to {{ phase.end_date }}
                                    </p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editPhaseModal"
                                                data-phase-id="{{ phase.id }}"
                                                data-phase-type="{{ phase.phase_type }}"
                                                data-start-date="{{ phase.start_date|date:'Y-m-d' }}"
                                                data-end-date="{{ phase.end_date|date:'Y-m-d' }}"
                                                data-notes="{{ phase.notes }}"
                                                data-completed="{{ phase.completed }}">
                                            <i class="mdi mdi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deletePhaseModal"
                                                data-phase-id="{{ phase.id }}">
                                            <i class="mdi mdi-delete"></i>
                                        </button>
                                    </div>
                                </div>
                            {% if phase.notes %}
                            <p class="mt-2 small text-muted">{{ phase.notes }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Milestones -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Milestones</h5>
                        <div>
                            <!-- <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMilestoneModal">
                                <i class="mdi mdi-plus"></i> Add Milestone
                            </button> -->
                            <span class="badge bg-light text-dark me-2">
                                {{ milestones|length }} total
                            </span>                            
                        </div>
                    </div>
                    
                    <div class="list-group list-group-flush phase-milestone-list" 
                         style="max-height: 300px; overflow-y: auto;">
                        {% for milestone in milestones %}
                        <div class="list-group-item border-0 px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center flex-nowrap mb-1">
                                    <strong class="text-truncate me-2">{{ milestone.name }}</strong>
                                    <span class="badge
                                        {% if milestone.status == 'completed' %}bg-success
                                        {% elif milestone.status == 'overdue' %}bg-danger
                                        {% else %}bg-info{% endif %}">
                                        {{ milestone.get_status_display }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center flex-nowrap">
                                    <p class="text-muted mb-0 small text-truncate">
                                        Due {{ milestone.due_date }}
                                    </p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editMilestoneModal"
                                                data-milestone-id="{{ milestone.id }}"
                                                data-name="{{ milestone.name }}"
                                                data-due-date="{{ milestone.due_date|date:'Y-m-d' }}"
                                                data-description="{{ milestone.description }}"
                                                data-status="{{ milestone.status }}">
                                            <i class="mdi mdi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteMilestoneModal"
                                                data-milestone-id="{{ milestone.id }}">
                                            <i class="mdi mdi-delete"></i>
                                        </button>
                                    </div>
                                </div>
                            {% if milestone.description %}
                            <p class="mt-2 small text-muted">{{ milestone.description }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gantt Chart -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Gantt Chart</h5>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMilestoneModal">
                    <i class="mdi mdi-plus"></i> Add Milestone
                </button>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPhaseModal">
                    <i class="mdi mdi-plus"></i> Add Phase
                </button>
            </div>
            {{ gantt_chart|safe }}            
        </div>
    </div>

    <!-- Documents Table -->
    <div class="card mb-4 mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Documents</h5>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                    <i class="mdi mdi-plus"></i> Add Document
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Uploaded</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        <tr>
                            <td>{{ document.name }}</td>
                            <td>{{ document.uploaded_at|date:"Y-m-d" }}</td>
                            <td>{{ document.description|default:"-"|truncatechars:40 }}</td>
                            <td>
                                <a href="{{ document.document.url }}" class="btn btn-sm btn-outline-primary" download>
                                    <i class="mdi mdi-download"></i> Download
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">No documents uploaded yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>   
</div>

<!-- Add/Edit Phase Modal -->
<div class="modal fade" id="editPhaseModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Edit Evaluation Phase</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="phase_id" id="editPhaseId">
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Phase Type</label>
                        <select class="form-select form-select-lg rounded-3" name="phase_type" id="editPhaseType" required>
                            <option value="baseline">Baseline Evaluation</option>
                            <option value="midline">Midline Evaluation</option>
                            <option value="endline">Endline Evaluation</option>
                            <option value="inception">Inception</option>
                            <option value="design">Design</option>
                            <option value="data_collection">Data Collection</option>
                            <option value="analysis">Analysis</option>
                            <option value="reporting">Reporting</option>
                            <option value="dissemination">Dissemination</option>
                        </select>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Start Date</label>
                            <input type="date" class="form-control form-control-lg rounded-3" name="start_date" id="editStartDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">End Date</label>
                            <input type="date" class="form-control form-control-lg rounded-3" name="end_date" id="editEndDate" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Notes</label>
                        <textarea class="form-control form-control-lg rounded-3" name="notes" id="editNotes" rows="3"></textarea>
                    </div>
                    <div class="mb-4 form-check">
                        <input type="checkbox" class="form-check-input" name="completed" id="editCompleted">
                        <label class="form-check-label" for="editCompleted">Mark as completed</label>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Phase Modal -->
<div class="modal fade" id="addPhaseModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Add Evaluation Phase</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Phase Type</label>
                        <select class="form-select form-select-lg rounded-3" name="phase_type" required>
                            <option value="baseline">Baseline Evaluation</option>
                            <option value="midline">Midline Evaluation</option>
                            <option value="endline">Endline Evaluation</option>
                            <option value="inception">Inception</option>
                            <option value="design">Design</option>
                            <option value="data_collection">Data Collection</option>
                            <option value="analysis">Analysis</option>
                            <option value="reporting">Reporting</option>
                            <option value="dissemination">Dissemination</option>
                        </select>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Start Date</label>
                            <input type="date" class="form-control form-control-lg rounded-3" name="start_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">End Date</label>
                            <input type="date" class="form-control form-control-lg rounded-3" name="end_date" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Notes</label>
                        <textarea class="form-control form-control-lg rounded-3" name="notes" rows="3"></textarea>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status, aria-hidden="true"></span>
                            Add Phase
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Document Modal -->
<div class="modal fade" id="addDocumentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Upload Document</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" enctype="multipart/form-data" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Document Name</label>
                        <input type="text" name="name" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea name="description" class="form-control form-control-lg rounded-3" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">File</label>
                        <input type="file" name="document" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="document_submit" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="mdi mdi-upload"></i> Upload
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Phase Confirmation Modal -->
<div class="modal fade" id="deletePhaseModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <p>Are you sure you want to delete this phase? This action cannot be undone.</p>
                <form method="post" action="{% url 'project_detail' project.id %}" id="deletePhaseForm">
                    {% csrf_token %}
                    <input type="hidden" name="phase_id" id="deletePhaseId">
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="hidden" name="phase_type" value="delete">
                </form>
            </div>
            <div class="modal-footer bg-light border-top-0 px-4 py-3">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deletePhaseForm" class="btn btn-danger rounded-pill px-4">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Document Modal -->
<div class="modal fade" id="viewDocumentModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="viewDocumentTitle">Document</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="documentViewer" style="width:100%; height:500px; border:none;"></iframe>
            </div>
            <div class="modal-footer bg-light border-top-0 px-4 py-3">
                <a id="documentDownloadLink" href="#" class="btn btn-primary rounded-pill px-4" download>
                    <i class="mdi mdi-download"></i> Download
                </a>
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Milestone Modal -->
<div class="modal fade" id="addMilestoneModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Add Milestone</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal", aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Name</label>
                        <input type="text" class="form-control form-control-lg rounded-3" name="name" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Due Date</label>
                        <input type="date" class="form-control form-control-lg rounded-3" name="due_date" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control form-control-lg rounded-3" name="description" rows="3"></textarea>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="add_milestone" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Add Milestone
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Milestone Modal -->
<div class="modal fade" id="editMilestoneModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Edit Milestone</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="milestone_id" id="editMilestoneId">
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Name</label>
                        <input type="text" class="form-control form-control-lg rounded-3" name="name" id="editMilestoneName" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Due Date</label>
                        <input type="date" class="form-control form-control-lg rounded-3" name="due_date" id="editMilestoneDueDate" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control form-control-lg rounded-3" name="description" id="editMilestoneDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Status</label>
                        <select class="form-select form-select-lg rounded-3" name="status" id="editMilestoneStatus" required>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="update_milestone" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Milestone Confirmation Modal -->
<div class="modal fade" id="deleteMilestoneModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bæžs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <p>Are you sure you want to delete this milestone? This action cannot be undone.</p>
                <form method="post" action="{% url 'project_detail' project.id %}" id="deleteMilestoneForm">
                    {% csrf_token %}
                    <input type="hidden" name="milestone_id" id="deleteMilestoneId">
                    <input type="hidden" name="_method" value="DELETE">
                </form>
            </div>
            <div class="modal-footer bg-light border-top-0 px-4 py-3">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteMilestoneForm" class="btn btn-danger rounded-pill px-4">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Metric Modal -->
<div class="modal fade" id="addMetricModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Add Progress Metric</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 py-3">
                <form method="post" action="{% url 'project_detail' project.id %}">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Metric Name</label>
                        <input type="text" name="name" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Value</label>
                        <input type="number" name="value" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Target</label>
                        <input type="number" name="target" class="form-control form-control-lg rounded-3">
                    </div>
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Date Recorded</label>
                        <input type="date" name="date_recorded" class="form-control form-control-lg rounded-3" required>
                    </div>
                    <div class="modal-footer bg-light border-top-0 px-4 py-3">
                        <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="metric_submit" class="btn btn-primary rounded-pill px-4">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Add Metric
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle milestone status toggles via AJAX
    document.querySelectorAll('.toggle-milestone').forEach(button => {
        button.addEventListener('click', async function() {
            const milestoneId = this.dataset.milestoneId;
            const projectId = this.dataset.projectId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            try {
                const response = await fetch(`/research/project/${projectId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        'milestone_id': milestoneId,
                        'toggle_milestone': 'true'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Update button appearance
                        this.className = `btn btn-sm ${data.button_class} toggle-milestone`;
                        this.textContent = data.status_display;
                    }
                } else {
                    console.error('Error toggling milestone');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });
    });


    // Handle edit phase modal
    const editPhaseModal = document.getElementById('editPhaseModal');
    if (editPhaseModal) {
        editPhaseModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('editPhaseId').value = button.getAttribute('data-phase-id');
            document.getElementById('editPhaseType').value = button.getAttribute('data-phase-type');
            document.getElementById('editStartDate').value = button.getAttribute('data-start-date');
            document.getElementById('editEndDate').value = button.getAttribute('data-end-date');
            document.getElementById('editNotes').value = button.getAttribute('data-notes');
            document.getElementById('editCompleted').checked = button.getAttribute('data-completed') === 'True';
        });
    }

    // Handle delete phase modal
    const deletePhaseModal = document.getElementById('deletePhaseModal');
    if (deletePhaseModal) {
        deletePhaseModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('deletePhaseId').value = button.getAttribute('data-phase-id');
        });
    }

    // Handle edit milestone modal
    const editMilestoneModal = document.getElementById('editMilestoneModal');
    if (editMilestoneModal) {
        editMilestoneModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('editMilestoneId').value = button.getAttribute('data-milestone-id');
            document.getElementById('editMilestoneName').value = button.getAttribute('data-name');
            document.getElementById('editMilestoneDueDate').value = button.getAttribute('data-due-date');
            document.getElementById('editMilestoneDescription').value = button.getAttribute('data-description');
            document.getElementById('editMilestoneStatus').value = button.getAttribute('data-status');
        });
    }

    // Handle delete milestone modal
    const deleteMilestoneModal = document.getElementById('deleteMilestoneModal');
    if (deleteMilestoneModal) {
        deleteMilestoneModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            document.getElementById('deleteMilestoneId').value = button.getAttribute('data-milestone-id');
        });
    }
});
</script>
{% endblock scripts %}
